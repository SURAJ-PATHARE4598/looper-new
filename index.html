<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob: https://cdn.auth0.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.auth0.com https://*.auth0.com; style-src 'self' 'unsafe-inline' https://cdn.auth0.com https://*.auth0.com; font-src 'self' https://cdn.auth0.com https://*.auth0.com data:; img-src 'self' data: blob: https: http:; connect-src 'self' https://*.auth0.com wss: ws:; media-src 'self' blob: data:;">
    <title>Looper Professional</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="startMsg" style="display:none;"></div>

    <!-- Loading screen -->
    <div id="loadingScreen" style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #191b22 0%, #23283a 100%);">
        <div style="text-align: center; color: #f5f6fa;">
            <h2>Loading Looper Professional...</h2>
            <div style="margin: 20px 0;">
                <div style="width: 50px; height: 50px; border: 4px solid #22ffe8; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
            <p>Initializing audio engine and authentication...</p>
        </div>
    </div>

    <!-- Main app content (hidden initially) -->
    <div id="mainApp" style="display: none;">
        <!-- Header -->
        <div class="header">
            <h1>üéõÔ∏è Looper Professional</h1>
            <div id="bpmLabel">BPM: --</div>
        </div>

        <!-- Before FX Row -->
        <div class="before-fx-row">
            <button id="beforeFxReverb" class="before-fx-btn">Reverb</button>
            <button id="beforeFxDelay" class="before-fx-btn">Delay</button>
            <button id="beforeFxFlanger" class="before-fx-btn">Flanger</button>
            <button id="beforeFxEq5" class="before-fx-btn">5-Band EQ</button>
            <button id="beforeFxPitch" class="before-fx-btn">Pitch</button>
        </div>

        <!-- Pedal Board -->
        <div class="pedal-board">
            <!-- Track 1 -->
            <div class="looper-pedal">
                <div class="track-label">TRACK 1</div>
                <svg class="progress-ring" id="progressBar1">
                    <circle cx="46" cy="46" r="42" id="progressBar1"></circle>
                </svg>
                <div class="looper-icon" id="looperIcon1">‚ñ∂</div>
                <div class="looper-row">
                    <div class="state-display" id="stateDisplay1">Ready</div>
                </div>
                <div class="looper-vol-label">
                    Vol: <input type="range" id="volSlider1" class="looper-vol-slider" min="0" max="100" value="90">
                    <span id="volValue1">90%</span>
                </div>
                <div class="track-fx-labels" id="trackFxLabels1"></div>
                <button class="main-looper-btn" id="mainLooperBtn1">Record/Play</button>
                <button class="stop-btn" id="stopBtn1">Stop</button>
                <button class="fx-menu-btn" id="fxMenuBtn1">After FX</button>
            </div>

            <!-- Track 2 -->
            <div class="looper-pedal">
                <div class="track-label">TRACK 2</div>
                <svg class="progress-ring" id="progressBar2">
                    <circle cx="46" cy="46" r="42" id="progressBar2"></circle>
                </svg>
                <div class="looper-icon" id="looperIcon2">‚ñ∂</div>
                <div class="looper-row">
                    <div class="state-display" id="stateDisplay2">Ready</div>
                    <select id="divider2">
                        <option value="1">1x</option>
                        <option value="0.5">2x</option>
                        <option value="2">1/2x</option>
                    </select>
                </div>
                <div class="looper-vol-label">
                    Vol: <input type="range" id="volSlider2" class="looper-vol-slider" min="0" max="100" value="90">
                    <span id="volValue2">90%</span>
                </div>
                <div class="track-fx-labels" id="trackFxLabels2"></div>
                <button class="main-looper-btn" id="mainLooperBtn2">Record/Play</button>
                <button class="stop-btn" id="stopBtn2">Stop</button>
                <button class="fx-menu-btn" id="fxMenuBtn2">After FX</button>
            </div>

            <!-- Track 3 -->
            <div class="looper-pedal">
                <div class="track-label">TRACK 3</div>
                <svg class="progress-ring" id="progressBar3">
                    <circle cx="46" cy="46" r="42" id="progressBar3"></circle>
                </svg>
                <div class="looper-icon" id="looperIcon3">‚ñ∂</div>
                <div class="looper-row">
                    <div class="state-display" id="stateDisplay3">Ready</div>
                    <select id="divider3">
                        <option value="1">1x</option>
                        <option value="0.5">2x</option>
                        <option value="2">1/2x</option>
                    </select>
                </div>
                <div class="looper-vol-label">
                    Vol: <input type="range" id="volSlider3" class="looper-vol-slider" min="0" max="100" value="90">
                    <span id="volValue3">90%</span>
                </div>
                <div class="track-fx-labels" id="trackFxLabels3"></div>
                <button class="main-looper-btn" id="mainLooperBtn3">Record/Play</button>
                <button class="stop-btn" id="stopBtn3">Stop</button>
                <button class="fx-menu-btn" id="fxMenuBtn3">After FX</button>
            </div>

            <!-- Track 4 -->
            <div class="looper-pedal">
                <div class="track-label">TRACK 4</div>
                <svg class="progress-ring" id="progressBar4">
                    <circle cx="46" cy="46" r="42" id="progressBar4"></circle>
                </svg>
                <div class="looper-icon" id="looperIcon4">‚ñ∂</div>
                <div class="looper-row">
                    <div class="state-display" id="stateDisplay4">Ready</div>
                    <select id="divider4">
                        <option value="1">1x</option>
                        <option value="0.5">2x</option>
                        <option value="2">1/2x</option>
                    </select>
                </div>
                <div class="looper-vol-label">
                    Vol: <input type="range" id="volSlider4" class="looper-vol-slider" min="0" max="100" value="90">
                    <span id="volValue4">90%</span>
                </div>
                <div class="track-fx-labels" id="trackFxLabels4"></div>
                <button class="main-looper-btn" id="mainLooperBtn4">Record/Play</button>
                <button class="stop-btn" id="stopBtn4">Stop</button>
                <button class="fx-menu-btn" id="fxMenuBtn4">After FX</button>
            </div>
        </div>

        <!-- Live Monitor Button -->
        <button class="monitor-btn" id="liveMicMonitor">Live Monitor: OFF</button>

        <!-- Instructions -->
        <div style="text-align: center; margin: 30px auto; max-width: 800px; color: #a0b3c7; font-size: 1.1em;">
            <h3>üéπ Quick Start Guide</h3>
            <p><strong>Keyboard Shortcuts:</strong> W/S (Track 1), E/D (Track 2), R/F (Track 3), T/G (Track 4)</p>
            <p><strong>Recording:</strong> Click Record/Play or press key. Track 1 sets master tempo.</p>
            <p><strong>Effects:</strong> Before-FX affect input. After-FX are per-track chains.</p>
            <p><strong>Hold Stop:</strong> 2s to clear loop. Tap to pause/resume.</p>
        </div>
    </div>

    <!-- Before FX Popup -->
    <div id="fxBeforeParamsPopup" class="fx-popup hidden">
        <div class="fx-popup-inner">
            <div id="fxBeforeContent"><!-- Dynamic content --></div>
        </div>
    </div>

    <!-- After FX Menu Popup -->
    <div id="fxMenuPopup" class="fx-popup hidden">
        <div class="fx-popup-inner">
            <div id="fxMenuContent"><!-- Dynamic content --></div>
        </div>
    </div>

    <!-- After FX Params Popup -->
    <div id="fxParamsPopup" class="fx-popup hidden">
        <div class="fx-popup-inner">
            <div id="fxParamsContent"><!-- Dynamic content --></div>
        </div>
    </div>

    <!-- Auth0 SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>

    <!-- App Configuration -->
    <script src="auth-config.js"></script>
    <script src="auth-service.js"></script>
    <script src="script.js"></script>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        // Initialize the app after DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Auth0
                await initializeAuth();

                // Check if user needs to authenticate
                const requiresAuth = await authService.requireAuth();

                if (requiresAuth) {
                    // Hide loading screen and show main app
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';

                    // Initialize audio context and looper
                    console.log('App authenticated and ready');
                } else {
                    // Will redirect to login
                    console.log('Redirecting to login...');
                }
            } catch (error) {
                console.error('App initialization failed:', error);
                document.getElementById('loadingScreen').innerHTML = '<div style="text-align: center; color: #f5f6fa;"><h2>Authentication Error</h2><p>Please restart the application.</p></div>';
            }
        });
    </script>
</body>
</html>